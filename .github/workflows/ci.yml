name: Terraform CI

on:
  push:
    branches: [ main ]
  pull_request:
    branches: [ main ]

permissions:
  contents: read
  security-events: write

jobs:
  validate:
    name: Validate Terraform
    runs-on: ubuntu-latest
    strategy:
      matrix:
        example: [simple-s3]
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'
      
      - name: Terraform Format Check
        run: terraform fmt -check -recursive
        working-directory: examples/${{ matrix.example }}
      
      - name: Terraform Init
        run: terraform init
        working-directory: examples/${{ matrix.example }}
      
      - name: Terraform Validate
        run: terraform validate
        working-directory: examples/${{ matrix.example }}

  security:
    name: Security Scan
    runs-on: ubuntu-latest
    needs: validate
    steps:
      - uses: actions/checkout@v4
      
      - name: Run tfsec
        run: |
          docker run --rm -v "$(pwd)/examples:/src" aquasec/tfsec:latest /src --format sarif > tfsec-results.sarif
        continue-on-error: true
      
      - name: Debug - List generated files
        if: always()
        run: |
          echo "=== Files in current directory ==="
          ls -la
          echo "=== Files in examples directory ==="
          ls -la examples/ || true
      
      - name: Upload tfsec results to GitHub Security
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: tfsec-results.sarif
      
      - name: Run Trivy for IaC scanning
        uses: aquasecurity/trivy-action@master
        with:
          scan-type: 'config'
          scan-ref: 'examples'
          format: 'sarif'
          output: 'trivy-results.sarif'
        continue-on-error: true
      
      - name: Debug - Verify Trivy output
        if: always()
        run: |
          echo "=== Looking for Trivy results ==="
          ls -la trivy-results.sarif || echo "Trivy results file not found"
      
      - name: Upload Trivy IaC results
        uses: github/codeql-action/upload-sarif@v3
        if: always()
        with:
          sarif_file: 'trivy-results.sarif'

  plan:
    name: Terraform Plan (LocalStack)
    runs-on: ubuntu-latest
    needs: validate
    services:
      localstack:
        image: localstack/localstack:latest
        ports:
          - 4566:4566
        env:
          SERVICES: s3
          DEBUG: 1
    steps:
      - uses: actions/checkout@v4
      
      - name: Setup Terraform
        uses: hashicorp/setup-terraform@v3
        with:
          terraform_version: '1.6.0'
      
      - name: Wait for LocalStack
        run: |
          timeout 30 bash -c 'until curl -s http://localhost:4566/_localstack/health | grep -q "\"s3\": \"available\""; do sleep 1; done'
      
      - name: Terraform Init
        run: terraform init
        working-directory: examples/simple-s3
      
      - name: Terraform Plan
        run: terraform plan -out=tfplan
        working-directory: examples/simple-s3
        env:
          TF_VAR_use_localstack: true
          TF_VAR_bucket_name: test-bucket-${{ github.run_id }}
      
      - name: Upload plan artifact
        uses: actions/upload-artifact@v4
        with:
          name: terraform-plan
          path: examples/simple-s3/tfplan
          retention-days: 7
